# EHS Manager 審核通知測試指南

## 🎯 測試目標

模擬完整的申請流程：**創建新申請 → EHS Manager 收到通知 → 進行審核**

---

## 📋 測試步驟

### 步驟 1：啟動開發伺服器並查看終端機

**重要**：所有 Email 通知會輸出在**終端機控制台**中，所以請保持終端機視窗可見。

```powershell
# 啟動開發伺服器（如果尚未啟動）
$env:DATABASE_URL = "file:./dev.db"
npm run dev
```

**確認**：終端機顯示類似以下訊息，表示伺服器已啟動：
```
  ▲ Next.js 14.2.18
  - Local:        http://localhost:3000
  - Ready in 2.3s
```

---

### 步驟 2：訪問系統並創建新申請

1. **打開瀏覽器**，訪問：http://localhost:3000

2. **點擊右上角「新增申請」按鈕**

3. **填寫申請表單**（使用以下測試資料）：

   #### 申請人資訊
   - **廠內申請人**：`林忠信` ⭐（必填）
   - **部門**：`維修部` ⭐（必填）
   - **Email**：`test@company.com`（選填，用於接收審核結果通知）

   #### 施工申請資料
   - **作業時間開始**：選擇今天日期 + 時間（例如：2026-01-10 09:00）
   - **作業時間結束**：選擇今天日期 + 時間（例如：2026-01-10 17:00）
   - **施工區域**：`黑線2F室內與1F室` ⭐（必填）
   - **施工內容**：`集塵防爆隔離閱安裝` ⭐（必填）

   #### 工作環境危害因素
   - ✅ 勾選「**動火作業**」（必勾）

   #### 危險性作業（自動顯示）
   - 選擇「**動火**」：`是` 或 `否`

   #### 入廠作業人員
   - **承攬商名稱**：`飛弘科技公司` ⭐（必填）
   - **承攬商施工現場負責人**：`彭瑞泉` ⭐（必填）
   - **承攬商施工人員**：`彭瑞泉、林友濃` ⭐（必填，逗號分隔）

4. **點擊「提交申請」按鈕**

---

### 步驟 3：查看終端機中的 Email 通知 📧

**立即查看終端機**，您應該會看到類似以下的 Email 通知：

```
============================================================
📧 EMAIL NOTIFICATION
============================================================
To: ehs.manager@company.com
Subject: 【施工安全作業許可】新申請待審核
------------------------------------------------------------
您好，

有一份新的施工安全作業許可申請需要您審核：

申請人：林忠信
部門：維修部
施工區域：黑線2F室內與1F室

請點擊以下連結進行審核：
http://localhost:3000/applications/[申請ID]

此為系統自動發送，請勿直接回覆此郵件。

Link: http://localhost:3000/applications/[申請ID]
============================================================
```

**檢查點**：
- ✅ 收件人是否為 EHS Manager Email（預設：`ehs.manager@company.com`）
- ✅ 主旨是否正確
- ✅ 申請資訊是否正確（申請人、部門、施工區域）
- ✅ 連結是否可點擊（在終端機中，可以複製連結）

---

### 步驟 4：模擬 EHS Manager 收到通知並進行審核

#### 方式 A：使用通知中的連結

1. **複製終端機中的申請連結**（例如：`http://localhost:3000/applications/clxxxxx...`）

2. **在瀏覽器中打開該連結**（或直接在新分頁中訪問）

   **或者**，您也可以在申請提交後，系統會自動跳轉到申請詳情頁。

#### 方式 B：從首頁進入

1. 返回首頁（http://localhost:3000）
2. 在申請列表中，找到剛創建的申請
3. 點擊「查看詳情」或申請卡片

---

### 步驟 5：EHS Manager 審核申請

在申請詳情頁，您會看到：

1. **審核進度流程圖**
   - 目前顯示「待 EHS Manager 審核」（黃色高亮）

2. **審核表單區塊**（標題：EHS Manager 審核）

   #### 填寫審核資訊：

   - **審核人 Email**：`ehs.manager@company.com` ⭐
     - 這必須與系統設定的 EHS Manager Email 一致
     - 預設為環境變數 `EHS_MANAGER_EMAIL` 或 `ehs.manager@company.com`

   - **審核結果**：
     - 選擇「**通過**」→ 狀態變為「待主管審核」
     - 選擇「**拒絕**」→ **必須填寫附註說明**（至少 10 字元）

   - **附註說明**：
     - 如果選擇「通過」：可選填
     - 如果選擇「拒絕」：**必填**（至少 10 字元）

3. **點擊「提交審核」按鈕**

---

### 步驟 6：驗證審核結果和後續通知

#### 如果選擇「通過」

1. **查看終端機**，應該會看到新的 Email 通知：
   - **收件人**：部門主管 Email（例如：`manager.maintenance@company.com`）
   - **主旨**：`【施工安全作業許可】申請待最終審核`
   - **內容**：通知部門主管需要進行最終審核

2. **檢查申請詳情頁**：
   - 狀態更新為「待主管審核」
   - 審核進度流程圖更新
   - 顯示審核記錄（EHS Manager 的審核記錄）

#### 如果選擇「拒絕」

1. **驗證附註說明必填驗證**：
   - 不填附註說明 → 顯示錯誤：「拒絕時必須填寫附註說明（至少 10 個字元）」
   - 填寫少於 10 字元 → 顯示錯誤
   - 填寫至少 10 字元 → 可成功提交

2. **查看終端機**，應該會看到新的 Email 通知：
   - **收件人**：申請人 Email（如果在表單中填寫了）
   - **主旨**：`【施工安全作業許可】申請已拒絕`
   - **內容**：包含審核意見（附註說明）

3. **檢查申請詳情頁**：
   - 狀態更新為「已拒絕」
   - 顯示審核記錄（包含附註說明）

---

## 🔍 詳細檢查清單

### ✅ 申請提交階段

- [ ] 申請表單可以正常填寫
- [ ] 必填欄位驗證正常
- [ ] 提交成功後跳轉到申請詳情頁
- [ ] **終端機顯示 Email 通知**（給 EHS Manager）

### ✅ 通知內容檢查

- [ ] 收件人 Email 正確
- [ ] 主旨正確：`【施工安全作業許可】新申請待審核`
- [ ] 申請資訊正確（申請人、部門、施工區域）
- [ ] 連結正確且可訪問
- [ ] 連結指向正確的申請詳情頁

### ✅ EHS Manager 審核階段

- [ ] 可以訪問申請詳情頁
- [ ] 審核表單正常顯示
- [ ] 審核人 Email 驗證正常
- [ ] 選擇「通過」→ 狀態更新為「待主管審核」
- [ ] 選擇「拒絕」→ 附註說明必填驗證正常
- [ ] 審核記錄正確顯示

### ✅ 後續通知檢查

- [ ] 審核通過後，部門主管收到通知（終端機）
- [ ] 審核拒絕後，申請人收到通知（如果有填 Email）
- [ ] 通知內容正確

---

## 🎭 模擬情境範例

### 情境 1：正常審核流程

```
1. 申請人創建申請
   ↓
2. EHS Manager 收到通知（終端機顯示）
   ↓
3. EHS Manager 點擊連結，訪問申請詳情頁
   ↓
4. EHS Manager 審核通過（不填附註說明，或填寫）
   ↓
5. 部門主管收到通知（終端機顯示）
   ↓
6. 部門主管進行最終審核
   ↓
7. 申請人收到審核結果通知（如果填了 Email）
```

### 情境 2：EHS Manager 拒絕申請

```
1. 申請人創建申請
   ↓
2. EHS Manager 收到通知（終端機顯示）
   ↓
3. EHS Manager 審核拒絕
   - 嘗試不填附註說明 → 顯示錯誤 ❌
   - 填寫附註說明（至少 10 字元）→ 成功 ✅
   ↓
4. 申請人收到拒絕通知（終端機顯示，如果有填 Email）
   ↓
5. 狀態變更為「已拒絕」
```

---

## 💡 測試提示

1. **保持終端機可見**：所有通知都在終端機中顯示
2. **使用多個分頁**：可以同時打開申請頁面和審核頁面
3. **複製申請 ID**：從終端機通知中複製連結，方便直接訪問
4. **測試不同情境**：測試通過、拒絕（有附註、無附註）等不同情況

---

## 🐛 常見問題

### Q1: 終端機沒有顯示 Email 通知？

**檢查**：
- 確認申請是否成功提交（檢查瀏覽器是否跳轉到詳情頁）
- 確認終端機是否有錯誤訊息
- 確認控制台（F12）是否有錯誤

### Q2: 審核時顯示「無權限」？

**檢查**：
- 確認使用的 Email 是否與系統設定的 EHS Manager Email 一致
- 預設 Email：`ehs.manager@company.com`
- 可檢查 `.env` 檔案或環境變數 `EHS_MANAGER_EMAIL`

### Q3: 申請詳情頁無法打開？

**檢查**：
- 確認申請 ID 是否正確
- 確認伺服器是否正在運行
- 檢查終端機是否有錯誤訊息

---

## 📝 測試資料建議

為了完整測試，建議創建多筆申請：

1. **申請 1**：正常流程（EHS 通過 → 主管通過）
2. **申請 2**：EHS 拒絕（測試附註說明必填）
3. **申請 3**：不同的申請人和部門
4. **申請 4**：包含多種危害因素

---

祝測試順利！🎉
