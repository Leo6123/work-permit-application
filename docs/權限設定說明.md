# 權限設定說明

## 本專案：權限不在 Supabase 設，在「環境變數」設

本系統的**權限（誰可填單、誰可審 EHS、誰是營運經理等）**是依 **Email** 對照 **環境變數** 判斷的，**不是**在 Supabase Dashboard 裡設定。

- **Supabase 負責**：登入（建立使用者帳號：Email + 密碼）
- **本專案 .env / Vercel 環境變數負責**：這個 Email 擁有哪幾種權限

---

## 在 Supabase 要做的事（只有「建立可登入的使用者」）

1. 開啟 [Supabase Dashboard](https://supabase.com/dashboard) → 選你的專案
2. 左側 **Authentication** → **Users**
3. 點 **Add user**（或 Invite user）
4. 填寫：
   - **Email**：登入用的信箱（須與下面權限用的 Email 一致）
   - **Password**：密碼（至少 6 字元）
5. 儲存

這樣該使用者就能用「Email + 密碼」登入。**權限**則由下面環境變數決定，與 Supabase 裡沒有「角色」設定無關。

---

## 在本專案如何設定「不同權限」（.env 或 Vercel）

在專案根目錄的 `.env`，或 Vercel 的 **Environment Variables** 裡設定以下變數（未設定時會用程式內建預設值）：

| 環境變數 | 用途 | 格式範例 |
|----------|------|----------|
| `APPLICANT_LIST` | 可填單的申請人（姓名與登入 Email） | `Jack Chen:jack.chen@avient.com,Charlie Lin:charlie.lin@avient.com,David Yeh:david.yeh@avient.com` |
| `ADMIN_EMAILS` | 管理者（可進所有頁面、所有審核） | `cti912@hotmail.com` |
| `EHS_PERMISSION_EMAILS` | 可擔任 EHS 審核的登入者 | `attagal.lai@avient.com` |
| `OPERATIONS_MANAGER_PERMISSION_EMAILS` | 可擔任營運經理審核的登入者 | `leo.chang@avient.com` |
| `AREA_SUPERVISORS_PERMISSION` | 區域經理（名稱:Email，誰可審哪一區） | `生產經理:hamish.chen@avient.com,倉庫經理:xxx@avient.com` |

- 同一個 Email 可以出現在多個變數裡（例如既是申請人又是 EHS）。
- `ADMIN_EMAILS` 裡的人自動擁有所有審核權限，不需再填其他權限變數。

---

## 對照表：想給某人某權限要改哪裡

| 想給的權限 | 要設定的環境變數 | Supabase 要做的事 |
|------------|------------------|--------------------|
| 可以登入 | （無，有帳號就能登入） | Authentication → Users → Add user（該 Email + 密碼） |
| 可填單（申請人） | `APPLICANT_LIST` 裡加上 `姓名:該員Email` | 確保該 Email 在 Users 裡有帳號 |
| EHS 審核 | `EHS_PERMISSION_EMAILS` 裡加上該員 Email | 同上 |
| 營運經理審核 | `OPERATIONS_MANAGER_PERMISSION_EMAILS` 裡加上該員 Email | 同上 |
| 某區域經理 | `AREA_SUPERVISORS_PERMISSION` 裡加上 `區域名稱:該員Email` | 同上 |
| 管理者（全部權限） | `ADMIN_EMAILS` 裡加上該員 Email | 同上 |

**結論：在 Supabase 只設定「誰能登入」（建立 User）；「誰有什麼權限」一律在本專案的環境變數設定。**

---

## 若未來想改成「在 Supabase 設權限」

若希望改為在 Supabase 管理權限（例如用 Auth 的 **User Metadata** 存角色）：

1. 在 Supabase：Authentication → Users → 點該使用者 → 在 **User Metadata** 或 **App Metadata** 裡加欄位（例如 `role: "ehs"`）。
2. 在本專案程式裡改為讀取 `user.app_metadata.role`（或自訂欄位），不再只依環境變數的 Email 名單判斷。

目前程式**尚未**實作讀取 Supabase metadata，權限仍以環境變數為準。

---

## 後台頁面（僅管理者）

- **網址**：`/admin`
- **權限**：僅 `ADMIN_EMAILS` 內的管理者可存取；非管理者會被導回首頁。
- **內容**：
  1. **申請一覽**：誰發申請（申請人、Email、部門、施工區域、狀態、建立時間）、可點「查看」進詳情。
  2. **審核簽署紀錄**：誰在何時簽署（角色、Email、通過/拒絕、附註）、關聯申請案。
  3. **Email 發送紀錄**：每封通知的收件人、主旨、類型、發送時間、成功/失敗與錯誤訊息。
- **資料來源**：申請與審核來自既有資料表；Email 紀錄來自 **EmailLog** 表（每次發送通知時寫入）。部署後需執行一次 **`npx prisma db push`** 以建立 EmailLog 表。
