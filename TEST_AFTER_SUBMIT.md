# 提交申請後測試指南

## 🎯 測試目標

確認申請提交後，系統正確處理申請、通知 EHS Manager，並可以進行後續審核。

---

## 📋 完整測試流程

### 步驟 1：填寫並提交申請

1. **訪問申請表單頁**：http://localhost:3000/applications/new

2. **填寫申請表單**（至少填寫必填欄位）：

   #### 申請人資訊
   - **廠內申請人**：選擇 `Jack Chen`、`Charlie Lin`、`David Yeh` 或「其他(自行填入)」
   - **部門**：選擇 `維修部`、`生產部`、`實驗室`、`R&D` 或 `QC`
   - **Email**：（選填）例如：`test@company.com`

   #### 施工申請資料
   - **作業時間開始**：選擇今天日期 + 時間（例如：2026-01-10 09:00）
   - **作業時間結束**：選擇今天日期 + 時間（例如：2026-01-10 17:00）
   - **施工區域**：`黑線2F室內與1F室`
   - **施工內容**：`集塵防爆隔離閱安裝`

   #### 工作環境危害因素
   - ✅ 勾選「**動火作業**」（會顯示危險性作業選項）
   - 選擇「**動火**」：`是` 或 `否`

   #### 入廠作業人員
   - **承攬商名稱**：`飛弘科技公司`
   - **承攬商施工現場負責人**：`彭瑞泉`
   - **承攬商施工人員**：`彭瑞泉、林友濃`（逗號分隔）

3. **點擊「提交申請」按鈕**

---

### 步驟 2：確認提交結果 ✅

#### 2.1 檢查頁面跳轉

**預期結果**：
- ✅ 提交成功後，頁面自動跳轉到申請詳情頁
- ✅ URL 格式：`http://localhost:3000/applications/[申請ID]`

**如果提交失敗**：
- ❌ 頁面停留在表單頁面
- ❌ 顯示錯誤訊息（紅色提示框）
- 檢查錯誤訊息，修正後重新提交

#### 2.2 檢查申請詳情頁顯示

在申請詳情頁，確認以下內容正確顯示：

**申請資料**：
- ✅ 申請人姓名正確
- ✅ 部門正確
- ✅ 作業時間正確（開始/結束）
- ✅ 施工區域正確
- ✅ 施工內容正確
- ✅ 危害因素正確（動火作業已勾選）
- ✅ 承攬商資訊正確

**審核進度流程圖**：
- ✅ 顯示三個階段：EHS Manager 審核 → 部門主管審核 → 完成
- ✅ 目前狀態：**「待 EHS Manager 審核」**（黃色高亮）
- ✅ 狀態標籤顯示：「待 EHS 審核」

**審核表單**：
- ✅ 顯示「EHS Manager 審核」標題
- ✅ 審核人 Email 輸入框
- ✅ 審核結果選項（通過/拒絕）
- ✅ 附註說明輸入框

---

### 步驟 3：查看終端機中的 Email 通知 📧

**重要**：立即查看運行 `npm run dev` 的終端機視窗

#### 3.1 EHS Manager 通知

提交成功後，終端機應該顯示：

```
============================================================
📧 EMAIL NOTIFICATION
============================================================
To: ehs.manager@company.com
Subject: 【施工安全作業許可】新申請待審核
------------------------------------------------------------
您好，

有一份新的施工安全作業許可申請需要您審核：

申請人：Jack Chen
部門：維修部
施工區域：黑線2F室內與1F室

請點擊以下連結進行審核：
http://localhost:3000/applications/[申請ID]

此為系統自動發送，請勿直接回覆此郵件。

Link: http://localhost:3000/applications/[申請ID]
============================================================
```

**檢查點**：
- ✅ 收件人：`ehs.manager@company.com`（或您設定的 EHS_MANAGER_EMAIL）
- ✅ 主旨正確
- ✅ 申請資訊正確（申請人、部門、施工區域）
- ✅ 連結正確且可訪問

---

### 步驟 4：驗證申請已儲存到資料庫 ✅

#### 方式 A：從首頁查看

1. **返回首頁**：http://localhost:3000
2. **檢查申請列表**：
   - ✅ 剛提交的申請出現在列表中
   - ✅ 申請編號（前 8 碼）顯示
   - ✅ 申請人、部門、施工區域正確
   - ✅ 狀態顯示「待 EHS 審核」

3. **檢查統計卡片**：
   - ✅ 「最新申請」數字 +1
   - ✅ 「EHS 待審」數字 +1（如果之前是 0，現在應該是 1）

4. **測試篩選功能**：
   - 點擊「待 EHS 審核」Tab → 應該只顯示這筆申請
   - 點擊「全部案件」Tab → 顯示所有申請

#### 方式 B：使用 Prisma Studio（可選）

如果已安裝 Prisma，可以使用 Prisma Studio 查看資料庫：

```powershell
npx prisma studio
```

訪問 http://localhost:5555，查看：
- `WorkPermitApplication` 表中有新的記錄
- 資料欄位正確儲存

---

### 步驟 5：模擬 EHS Manager 進行審核 🎭

#### 5.1 訪問申請詳情頁

**方式 1**：從首頁進入
- 返回首頁
- 點擊申請列表中的「查看詳情」或申請卡片

**方式 2**：直接使用 URL
- 從終端機通知中複製申請連結
- 在瀏覽器中打開

#### 5.2 進行審核

在申請詳情頁的「審核表單」區塊：

1. **填寫審核資訊**：
   - **審核人 Email**：`ehs.manager@company.com` ⭐
   - **審核結果**：選擇「**通過**」或「**拒絕**」
   - **附註說明**：
     - 如果選擇「通過」：可選填
     - 如果選擇「拒絕」：**必填**（至少 10 字元）

2. **點擊「提交審核」按鈕**

#### 5.3 驗證審核結果

**如果選擇「通過」**：
- ✅ 狀態更新為「待主管審核」
- ✅ 審核進度流程圖更新
- ✅ 顯示審核記錄（EHS Manager 的審核記錄）
- ✅ **終端機顯示部門主管的通知**（查看終端機）

**如果選擇「拒絕」**：
- ✅ 狀態更新為「已拒絕」
- ✅ 審核記錄包含附註說明
- ✅ **終端機顯示申請人的通知**（如果有填 Email）

---

## ✅ 完整測試檢查清單

### 提交階段
- [ ] 表單驗證正常（必填欄位提示）
- [ ] 提交成功後跳轉到申請詳情頁
- [ ] 申請資料正確顯示
- [ ] 狀態顯示「待 EHS 審核」

### 通知階段
- [ ] 終端機顯示 EHS Manager 的 Email 通知
- [ ] 通知內容正確（申請人、部門、施工區域）
- [ ] 通知中的連結正確且可訪問

### 資料儲存階段
- [ ] 申請出現在首頁列表中
- [ ] 統計卡片數字正確更新
- [ ] Tab 篩選功能正常

### 審核階段
- [ ] 可以訪問申請詳情頁
- [ ] 審核表單正常顯示
- [ ] 審核操作正常（通過/拒絕）
- [ ] EHS Manager 拒絕時，附註說明必填驗證正常
- [ ] 審核後狀態正確更新
- [ ] 後續通知正確發送（終端機顯示）

---

## 🔍 常見問題排查

### Q1: 提交後沒有跳轉？

**檢查**：
- 查看瀏覽器控制台（F12）是否有錯誤
- 檢查終端機是否有錯誤訊息
- 確認所有必填欄位已填寫

### Q2: 終端機沒有顯示 Email 通知？

**檢查**：
- 確認申請是否成功提交（檢查是否跳轉到詳情頁）
- 檢查終端機是否有錯誤訊息
- 確認伺服器正在運行（`npm run dev`）

### Q3: 申請沒有出現在列表中？

**檢查**：
- 刷新首頁（F5）
- 確認資料庫連線正常
- 檢查終端機是否有資料庫錯誤

### Q4: 審核時顯示「無權限」？

**檢查**：
- 確認使用的 Email 與系統設定的 EHS Manager Email 一致
- 預設 Email：`ehs.manager@company.com`
- 檢查環境變數設定

---

## 📝 建議的測試情境

### 情境 1：完整流程測試

```
1. 創建申請
   ↓
2. 查看終端機通知 ✅
   ↓
3. EHS Manager 審核通過 ✅
   ↓
4. 查看終端機通知（部門主管）✅
   ↓
5. 部門主管審核通過 ✅
   ↓
6. 查看終端機通知（申請人）✅
   ↓
7. 確認最終狀態為「已通過」✅
```

### 情境 2：EHS Manager 拒絕測試

```
1. 創建申請
   ↓
2. EHS Manager 審核拒絕（不填附註）→ 錯誤 ❌
   ↓
3. EHS Manager 審核拒絕（填寫附註）→ 成功 ✅
   ↓
4. 確認狀態為「已拒絕」✅
   ↓
5. 查看終端機通知（申請人）✅
```

### 情境 3：不同部門測試

```
1. 創建「維修部」申請 → 通知對應的部門主管
2. 創建「生產部」申請 → 通知對應的部門主管
3. 創建「實驗室」申請 → 通知對應的部門主管（如果已設定）
```

---

## 💡 測試提示

1. **保持終端機可見**：所有通知都在終端機中顯示
2. **使用多個分頁**：可以同時打開申請頁面、詳情頁面和首頁
3. **測試不同組合**：測試不同申請人、部門、危害因素的組合
4. **測試邊界情況**：測試必填欄位驗證、拒絕時的附註說明等

---

祝測試順利！🎉
