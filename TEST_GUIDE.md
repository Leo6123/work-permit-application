# 測試指南 - 施工安全作業許可申請系統

## 📋 測試前準備

### 1. 確認依賴已安裝

```bash
npm install
```

### 2. 初始化資料庫

由於使用 Prisma + SQLite，首次運行時需要初始化資料庫：

```bash
# 設定環境變數（Windows PowerShell）
$env:DATABASE_URL="file:./dev.db"

# 產生 Prisma Client
npx prisma generate

# 推送資料庫 schema（建立資料庫檔案和表格）
npx prisma db push
```

或者直接在專案根目錄建立 `.env` 檔案（如果還未建立）：

```env
DATABASE_URL="file:./dev.db"
NEXT_PUBLIC_BASE_URL="http://localhost:3000"
EHS_MANAGER_EMAIL="ehs.manager@company.com"
DEPARTMENT_MANAGERS="維修部:manager.maintenance@company.com,生產部:manager.production@company.com"
```

### 3. 啟動開發伺服器

```bash
npm run dev
```

開啟瀏覽器訪問：http://localhost:3000

---

## 🧪 測試步驟

### 測試 1：首頁顯示 ✅

**目標**：確認首頁正常顯示，統計卡片和列表正常

**步驟**：
1. 訪問 http://localhost:3000
2. 確認看到深色工業風格介面
3. 確認統計卡片顯示：
   - 最新申請：0（初始狀態）
   - EHS 待審：0
   - 施工中：0
4. 確認 Tab 切換正常（全部案件、待 EHS 審核等）
5. 確認搜尋框顯示

**預期結果**：
- 介面正常顯示，無錯誤
- 統計數字正確
- 空狀態提示正常顯示

---

### 測試 2：創建新申請 ✅

**目標**：填寫並提交申請表單

**步驟**：
1. 點擊右上角「新增申請」按鈕
2. 填寫申請人資訊：
   - 廠內申請人：`林忠信`（必填）
   - 部門：`維修部`（必填）
   - Email：`test@company.com`（選填）
3. 填寫施工申請資料：
   - 作業時間開始：選擇今天日期 + 時間（例如：2026-01-10 09:00）
   - 作業時間結束：選擇今天日期 + 時間（例如：2026-01-10 17:00）
   - 施工區域：`黑線2F室內與1F室`（必填）
   - 施工內容：`集塵防爆隔離閱安裝`（必填）
4. 選擇工作環境危害因素：
   - 勾選「動火作業」（必勾）
5. 由於勾選了動火作業，會顯示「危險性作業」區塊：
   - 選擇「動火」：`是` 或 `否`
6. 填寫入廠作業人員：
   - 承攬商名稱：`飛弘科技公司`（必填）
   - 承攬商施工現場負責人：`彭瑞泉`（必填）
   - 承攬商施工人員：`彭瑞泉、林友濃`（必填，逗號分隔）
7. 點擊「提交申請」

**預期結果**：
- 表單驗證正常（必填欄位提示）
- 提交成功後跳轉到申請詳情頁
- 控制台顯示 Email 通知（通知 EHS Manager）

**檢查點**：
- ✅ 必填欄位驗證是否正常
- ✅ 動火作業邏輯驗證是否正常
- ✅ 提交後是否正確跳轉
- ✅ 資料是否正確儲存到資料庫

---

### 測試 3：查看申請詳情和進度 ✅

**目標**：確認申請詳情頁正常顯示

**步驟**：
1. 在申請詳情頁（提交後自動跳轉），確認顯示：
   - 申請資料完整
   - 審核進度流程圖（顯示「待 EHS Manager 審核」）
   - 申請狀態標籤

**預期結果**：
- 所有申請資料正確顯示
- 審核進度流程正確
- 狀態顯示為「待 EHS 審核」

---

### 測試 4：EHS Manager 審核 - 通過 ✅

**目標**：EHS Manager 審核申請並通過

**步驟**：
1. 在申請詳情頁，找到「審核表單」區塊
2. 確認顯示「EHS Manager 審核」
3. 填寫審核資訊：
   - 審核人 Email：`ehs.manager@company.com`（或環境變數中的 EHS_MANAGER_EMAIL）
   - 審核結果：選擇「通過」
   - 附註說明：可選填
4. 點擊「提交審核」

**預期結果**：
- 審核記錄新增
- 狀態變更為「待主管審核」
- 控制台顯示 Email 通知（通知部門主管）
- 審核進度流程更新

---

### 測試 5：EHS Manager 審核 - 拒絕 ✅（重要測試點）

**目標**：測試 EHS Manager 拒絕時必須填寫附註說明

**步驟**：
1. 創建一個新申請（重複測試 2）
2. 在申請詳情頁，填寫審核資訊：
   - 審核人 Email：`ehs.manager@company.com`
   - 審核結果：選擇「拒絕」
   - **不填寫附註說明**
3. 點擊「提交審核」

**預期結果**：
- ❌ 提交失敗
- 顯示錯誤訊息：「拒絕時必須填寫附註說明（至少 10 個字元）」

**繼續測試**：
1. 填寫附註說明（至少 10 字元）：`不符合安全規範，需要補充相關文件。`
2. 再次點擊「提交審核」

**預期結果**：
- ✅ 審核成功
- 狀態變更為「已拒絕」
- 控制台顯示 Email 通知（通知申請人）
- 審核記錄包含附註說明

**檢查點**：
- ✅ EHS Manager 拒絕時，附註說明是否為必填
- ✅ 附註說明字數驗證是否正常（至少 10 字元）
- ✅ 通過時附註說明是否為選填

---

### 測試 6：部門主管審核 ✅

**目標**：部門主管進行最終審核

**前置條件**：
- 有一筆已通過 EHS 審核的申請（狀態：待主管審核）

**步驟**：
1. 在申請詳情頁，確認狀態為「待主管審核」
2. 確認顯示「部門主管審核」
3. 填寫審核資訊：
   - 審核人 Email：`manager.maintenance@company.com`（或對應部門的主管 Email）
   - 審核結果：選擇「通過」或「拒絕」
   - 附註說明：選填（拒絕時建議填寫）
4. 點擊「提交審核」

**預期結果**：
- 如果通過：狀態變更為「已通過」，控制台顯示 Email 通知（通知申請人）
- 如果拒絕：狀態變更為「已拒絕」，控制台顯示 Email 通知（通知申請人）

---

### 測試 7：查看申請列表和篩選 ✅

**目標**：測試首頁的申請列表和篩選功能

**步驟**：
1. 返回首頁（http://localhost:3000）
2. 確認統計卡片更新：
   - 最新申請：顯示實際申請數量
   - EHS 待審：顯示待審數量
   - 施工中：顯示已通過數量
3. 測試 Tab 篩選：
   - 點擊「全部案件」：顯示所有申請
   - 點擊「待 EHS 審核」：只顯示 pending_ehs 的申請
   - 點擊「待主管審核」：只顯示 pending_manager 的申請
   - 點擊「已通過/施工中」：只顯示 approved 的申請
   - 點擊「已拒絕」：只顯示 rejected 的申請
4. 測試搜尋功能：
   - 在搜尋框輸入申請編號（前 8 碼）
   - 在搜尋框輸入申請人姓名
   - 在搜尋框輸入部門名稱
   - 在搜尋框輸入施工區域
   - 在搜尋框輸入承攬商名稱

**預期結果**：
- 統計數字正確更新
- Tab 篩選正常運作
- 搜尋功能正常（即時過濾）

---

### 測試 8：完整流程測試 ✅

**目標**：測試完整的申請到審核流程

**步驟**：
1. 創建一個新申請
2. EHS Manager 審核通過
3. 部門主管審核通過
4. 確認最終狀態為「已通過」
5. 確認審核記錄完整
6. 確認 Email 通知正常（查看控制台）

**預期結果**：
- 所有狀態轉換正常
- 所有審核記錄正確
- 所有 Email 通知正確發送（console.log）

---

## 🔍 檢查 Email 通知（模擬）

所有 Email 通知都會在**終端機控制台**中顯示，格式如下：

```
============================================================
📧 EMAIL NOTIFICATION
============================================================
To: ehs.manager@company.com
Subject: 【施工安全作業許可】新申請待審核
------------------------------------------------------------
您好，

有一份新的施工安全作業許可申請需要您審核：

申請人：林忠信
部門：維修部
施工區域：黑線2F室內與1F室

請點擊以下連結進行審核：
http://localhost:3000/applications/[申請ID]

此為系統自動發送，請勿直接回覆此郵件。

Link: http://localhost:3000/applications/[申請ID]
============================================================
```

**測試時請注意查看終端機輸出**，確認：
- ✅ 申請提交後，EHS Manager 收到通知
- ✅ EHS 審核通過後，部門主管收到通知
- ✅ 審核完成後，申請人收到通知（如有填寫 Email）

---

## 🐛 常見問題排查

### 1. 資料庫連接錯誤

**問題**：`Error: Cannot find module '@prisma/client'` 或資料庫連接錯誤

**解決**：
```bash
# 重新產生 Prisma Client
npx prisma generate

# 確認 .env 檔案存在且包含 DATABASE_URL
```

### 2. 資料庫表格不存在

**問題**：API 請求時出現資料庫錯誤

**解決**：
```bash
# 推送 schema 到資料庫
npx prisma db push
```

### 3. 表單驗證錯誤

**問題**：提交時顯示驗證錯誤

**檢查**：
- 確認所有必填欄位已填寫
- 確認 Email 格式正確（如有填寫）
- 確認動火作業邏輯（勾選動火作業時，危險性作業必須選擇）

### 4. 審核權限錯誤

**問題**：審核時顯示「無權限」或「不在等待審核階段」

**檢查**：
- 確認使用的 Email 與系統設定的審核人員 Email 一致
- 確認申請的當前狀態正確
- 檢查環境變數設定（EHS_MANAGER_EMAIL、DEPARTMENT_MANAGERS）

---

## ✅ 測試檢查清單

完成所有測試後，確認以下項目：

- [ ] 首頁正常顯示，統計卡片正確
- [ ] 可以創建新申請，表單驗證正常
- [ ] 申請詳情頁正常顯示，進度流程正確
- [ ] EHS Manager 可以審核申請（通過和拒絕）
- [ ] EHS Manager 拒絕時，附註說明必填驗證正常
- [ ] 部門主管可以進行最終審核
- [ ] 申請列表正常顯示，篩選和搜尋正常
- [ ] Email 通知正常輸出到控制台
- [ ] 資料正確儲存到資料庫
- [ ] 狀態轉換正確（pending_ehs → pending_manager → approved/rejected）

---

## 📝 測試資料建議

為了完整測試，建議創建以下測試資料：

1. **多筆不同狀態的申請**：
   - 待 EHS 審核
   - 待主管審核
   - 已通過
   - 已拒絕

2. **不同部門的申請**：
   - 維修部
   - 生產部

3. **測試邊界情況**：
   - 所有欄位都填寫
   - 只填必填欄位
   - 包含再承攬商的申請

---

祝測試順利！🎉
